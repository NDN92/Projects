package de.NDN.app.writeInvoice;

import java.awt.print.Printable;
import java.awt.print.PrinterJob;
import java.util.ArrayList;

import de.NDN.app.globalObjects.CustomerType;
import de.NDN.app.writeInvoice.document.DocumentInvoice;
import de.NDN.app.writeInvoice.document.DocumentInvoiceFactory;
import de.NDN.app.writeInvoice.document.print.DocumentInvoicePrintable;
import de.NDN.app.writeInvoice.document.print.DocumentInvoicePrinter;
import javafx.scene.web.WebEngine;
import javafx.scene.web.WebView;

public class WriteInvoiceModel {
	
	private WriteInvoiceStage wInvS;
	private WriteInvoiceJsInterface wInvJsI;
	private WriteInvoiceController wInvC;
	private WriteInvoiceView wInvV;
	private WebView browser;
	private WebEngine engine;
	private CustomerType customerType;
	private DocumentInvoice doc;
	private DocumentInvoiceFactory documentInvoiceFactory;
	
	private final double STD_PAGE_WIDTH = PrinterJob.getPrinterJob().defaultPage().getWidth();
	private final double STD_PAGE_HEIGHT = PrinterJob.getPrinterJob().defaultPage().getHeight();
	private final int STD_PAGE_DPI = 72;
	private final int VIEW_PAGE_ZOOM_INTERVAL = 20;	
	private final int VIEW_PAGE_ZOOM_MIN = 10;
	private final int VIEW_PAGE_ZOOM_MAX = 500;
	private final int VIEW_PAGE_SHADOW_BLUR = 10;
	private final int VIEW_PAGE_MARGIN = 10;
	
	private double pageWidth = this.STD_PAGE_WIDTH;
	private double pageHeight = this.STD_PAGE_HEIGHT;
	private int pageDpi = 72;
	private double pageDpiRatio = ((double) this.pageDpi) / ((double) this.STD_PAGE_DPI);
	private int viewPageZoom = 100;
	private boolean viewPageFitWidth = false;
	private boolean viewPageFitHeight = false;	
	
	public WriteInvoiceModel(CustomerType customerType) {		
		this.customerType = customerType;
	}
	
	public void initWriteInvoice() {
		this.wInvS = new WriteInvoiceStage(this);
		this.browser = this.wInvS.getBrowser();
		this.engine = this.wInvS.getEngine();
		
		this.wInvJsI = new WriteInvoiceJsInterfaceImpl(this.engine);
//      	this.wInvC = new WriteInvoiceController(this.browser, this.engine);
//      	this.wInvV = new WriteInvoiceView(this.browser, this.engine);
      	
		this.documentInvoiceFactory = new DocumentInvoiceFactory(this.engine, this);
		this.documentInvoiceFactory.createNewDocument(this.customerType);
		
      	wInvS.show();
	}
	
	public void setDefaults() {
		
		//Adjust Page Resolution
		if(this.pageDpi != this.STD_PAGE_DPI) {
			this.pageWidth = this.pageDpiRatio * this.STD_PAGE_WIDTH;
			this.pageHeight = this.pageDpiRatio * this.STD_PAGE_HEIGHT;
		}
		
		setViewPageZoom( fitToViewPageHeight(this.viewPageZoom) );
		this.engine.executeScript("setPageSize(" + this.pageWidth + ", " + this.pageHeight + ");");
		
		if( this.documentInvoiceFactory.showDocumentOnViewPage() ) {
			this.engine.executeScript("setEventListener();");
		}
	}
	
	public void zoomInViewPage() {
		int newViewPageZoom = this.viewPageZoom + this.VIEW_PAGE_ZOOM_INTERVAL;		
		newViewPageZoom = checkViewPageFit(newViewPageZoom);		
		
		if(newViewPageZoom <= VIEW_PAGE_ZOOM_MAX) {
			setViewPageZoom(newViewPageZoom);
		}
	}
	public void zoomOutViewPage() {
		int newViewPageZoom = this.viewPageZoom - this.VIEW_PAGE_ZOOM_INTERVAL;		
		newViewPageZoom = checkViewPageFit(newViewPageZoom);
		
		if(newViewPageZoom >= VIEW_PAGE_ZOOM_MIN) {
			setViewPageZoom(newViewPageZoom);
		}
	}
	
	public int checkViewPageFit(int newViewPageZoom) {
		double oldPageWidth = this.pageWidth * (this.viewPageZoom / 100.0);
		double newPageWidth = this.pageWidth * (newViewPageZoom / 100.0);
		int width = this.wInvJsI.getViewPageWrapperWidth();		
		
		if(width > oldPageWidth && width < newPageWidth && !this.viewPageFitWidth) {
			double zoom = ( (width - 40.0) / this.pageWidth ) * 100 ;
			newViewPageZoom = (int) zoom;
			this.viewPageFitWidth = true;
		} else {
			this.viewPageFitWidth = false;
			if((newViewPageZoom - 100) % this.VIEW_PAGE_ZOOM_INTERVAL != 0) {
				double zoom = ((double) newViewPageZoom - 100) / this.VIEW_PAGE_ZOOM_INTERVAL;
				newViewPageZoom = ((int) Math.round(zoom)) * this.VIEW_PAGE_ZOOM_INTERVAL + 100;
			}
			
			
			double oldPageHeight = this.pageHeight * (this.viewPageZoom / 100.0);
			double newPageHeight = this.pageHeight * (newViewPageZoom / 100.0);
			int height = this.wInvJsI.getViewPageWrapperHeight();
			
			if(height > oldPageHeight && height < newPageHeight && !this.viewPageFitHeight) {
				double zoom = ( (height - 40.0) / this.pageHeight ) * 100 ;
				newViewPageZoom = (int) zoom;
				this.viewPageFitHeight = true;
			} else {
				this.viewPageFitHeight = false;
				if((newViewPageZoom - 100) % this.VIEW_PAGE_ZOOM_INTERVAL != 0) {
					double zoom = ((double) newViewPageZoom - 100) / this.VIEW_PAGE_ZOOM_INTERVAL;
					newViewPageZoom = ((int) Math.round(zoom)) * this.VIEW_PAGE_ZOOM_INTERVAL + 100;
				}
			}
		}
		
		return newViewPageZoom;
	}
	
	private int fitViewToPageWidth(int newViewPageZoom) {
		int width = this.wInvJsI.getViewPageWrapperWidth();		
		double zoom = ( (width - 40.0) / this.pageWidth ) * 100 ;
		newViewPageZoom = (int) zoom;
		this.viewPageFitWidth = true;
		
		return newViewPageZoom;
	}
	
	private int fitToViewPageHeight(int newViewPageZoom) {
		int height = this.wInvJsI.getViewPageWrapperHeight();
		double zoom = ( (height - 40.0) / this.pageHeight ) * 100 ;
		newViewPageZoom = (int) zoom;
		this.viewPageFitHeight = true;
		
		return newViewPageZoom;
	}
	
	public void printDocument() {
		DocumentInvoicePrinter test = this.documentInvoiceFactory.getDocumentInvoicePrinter();
		this.documentInvoiceFactory.getDocumentInvoicePrinter().doPrint();
	}
	
	public void updateText(String id, String newText) {
		ArrayList<Printable> printableDocuments = this.documentInvoiceFactory.getPrintableDocuments();
		for(Printable doc : printableDocuments) {
			ArrayList<Object[]> newPageTexts = ((DocumentInvoicePrintable) doc).getPageTexts();			
			for(int i = 0; i < newPageTexts.size(); i++) {
				Object[] textElem = newPageTexts.get(i);
				if( ((String) textElem[0]).contains(id) ) {
					newPageTexts.get(i)[1] = newText;
					break;
				}
			}
			((DocumentInvoicePrintable) doc).setPageTexts(newPageTexts);
		}
	}
	public void updateAddressField(String id, String newText, String wrapper) {
		ArrayList<Integer> removeIndexes = new ArrayList<Integer>();
		ArrayList<Printable> printableDocuments = this.documentInvoiceFactory.getPrintableDocuments();
		for(Printable doc : printableDocuments) {
			ArrayList<Object[]> newPageTexts = ((DocumentInvoicePrintable) doc).getPageTexts();			
			for(int i = 0; i < newPageTexts.size(); i++) {
				Object[] textElem = newPageTexts.get(i);
				if( ((String) textElem[0]).contains(id) ) {
					removeIndexes.add(i);
				}
			}
			((DocumentInvoicePrintable) doc).setPageTexts(newPageTexts);
			for(int index : removeIndexes) {
				newPageTexts.remove(index);
			}
		}
		
		ArrayList<String> texts = new ArrayList<String>();
		if(newText.contains("<br>")) {
			String text;
			while( newText.contains("<br>") ) {
				text = newText.substring(0, newText.indexOf("<br>"));
				texts.add(text);
				newText = newText.substring(newText.indexOf("<br>") + 4, newText.length());
			}
			texts.add(newText);
		} else {
			texts.add(newText);
		}
		
		
		this.documentInvoiceFactory.setAddressField(texts);
	}
	
	public String getAttrValue(String attr, String htmlCode, String type) {
		String val = htmlCode;
		
		int index1 = val.indexOf(attr);
		val = val.substring(index1);
		int index21 = val.indexOf(";");
		int index22 = val.indexOf("\"");		
		if( index21 < index22 ) val = val.substring(0, index21);
		else val = val.substring(0, index22);
		val = val.replace(attr, "");
		val = val.replace(":", "");
		val = val.trim();
		if(type.equals("int")) {
			val = val.replace("px", "");
		}
		return val;
	}
	
	
	//Getter and Setter
	public int getViewPageZoom() {
		return viewPageZoom;
	}

	public void setViewPageZoom(int viewPageZoom) {
		this.viewPageZoom = viewPageZoom;
		//this.wInvV.changeViewPageZoom(viewPageZoom);
		int newViewPageShadowBlur = (int) Math.round(this.VIEW_PAGE_SHADOW_BLUR / (viewPageZoom / 100.0));
		int newViewPageMargin = (int) Math.round(this.VIEW_PAGE_MARGIN / (viewPageZoom / 100.0));		
		
		this.engine.executeScript("changeViewPageZoom(" + viewPageZoom + ", " + newViewPageShadowBlur + ", " + newViewPageMargin + ");");
	}

	public WriteInvoiceStage getwInvS() {
		return wInvS;
	}

	public void setwInvS(WriteInvoiceStage wInvS) {
		this.wInvS = wInvS;
	}

	public WriteInvoiceJsInterface getwInvJsI() {
		return wInvJsI;
	}

	public void setwInvJsI(WriteInvoiceJsInterface wInvJsI) {
		this.wInvJsI = wInvJsI;
	}

	public WriteInvoiceController getwInvC() {
		return wInvC;
	}

	public void setwInvC(WriteInvoiceController wInvC) {
		this.wInvC = wInvC;
	}

	public WriteInvoiceView getwInvV() {
		return wInvV;
	}

	public void setwInvV(WriteInvoiceView wInvV) {
		this.wInvV = wInvV;
	}

	public WebView getBrowser() {
		return browser;
	}

	public void setBrowser(WebView browser) {
		this.browser = browser;
	}

	public WebEngine getEngine() {
		return engine;
	}

	public void setEngine(WebEngine engine) {
		this.engine = engine;
	}

	public CustomerType getCustomerType() {
		return customerType;
	}

	public void setCustomerType(CustomerType customerType) {
		this.customerType = customerType;
	}

	public DocumentInvoice getDoc() {
		return doc;
	}

	public void setDoc(DocumentInvoice doc) {
		this.doc = doc;
	}

	public DocumentInvoiceFactory getDocumentInvoiceFactory() {
		return documentInvoiceFactory;
	}

	public void setDocumentInvoiceFactory(DocumentInvoiceFactory documentInvoiceFactory) {
		this.documentInvoiceFactory = documentInvoiceFactory;
	}

	public boolean isViewPageFitWidth() {
		return viewPageFitWidth;
	}

	public void setViewPageFitWidth(boolean viewPageFitWidth) {
		this.viewPageFitWidth = viewPageFitWidth;
	}

	public boolean isViewPageFitHeight() {
		return viewPageFitHeight;
	}

	public void setViewPageFitHeight(boolean viewPageFitHeight) {
		this.viewPageFitHeight = viewPageFitHeight;
	}

	public int getVIEW_PAGE_ZOOM_INTERVAL() {
		return VIEW_PAGE_ZOOM_INTERVAL;
	}

	public int getVIEW_PAGE_ZOOM_MIN() {
		return VIEW_PAGE_ZOOM_MIN;
	}

	public int getVIEW_PAGE_ZOOM_MAX() {
		return VIEW_PAGE_ZOOM_MAX;
	}

	public int getVIEW_PAGE_SHADOW_BLUR() {
		return VIEW_PAGE_SHADOW_BLUR;
	}

	public int getVIEW_PAGE_MARGIN() {
		return VIEW_PAGE_MARGIN;
	}

	public double getPageWidth() {
		return pageWidth;
	}

	public void setPageWidth(double pageWidth) {
		this.pageWidth = pageWidth;
	}

	public double getPageHeight() {
		return pageHeight;
	}

	public void setPageHeight(double pageHeight) {
		this.pageHeight = pageHeight;
	}

	public int getPageDpi() {
		return pageDpi;
	}

	public void setPageDpi(int pageDpi) {
		this.pageDpi = pageDpi;
	}

	public double getSTD_PAGE_WIDTH() {
		return STD_PAGE_WIDTH;
	}

	public double getSTD_PAGE_HEIGHT() {
		return STD_PAGE_HEIGHT;
	}

	public int getSTD_PAGE_DPI() {
		return STD_PAGE_DPI;
	}

	public double getPageDpiRatio() {
		return pageDpiRatio;
	}

	public void setPageDpiRatio(double pageDpiRatio) {
		this.pageDpiRatio = pageDpiRatio;
	}
	

}
